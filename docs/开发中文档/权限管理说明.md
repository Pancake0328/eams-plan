# 权限管理（RBAC）实施与使用说明

> 适用版本：2026-02-07 之后  
> 目标：实现“用户 → 角色 → 权限”的完整闭环，并保证**页面、按钮、接口**三端一致受控。

## 一、背景与目标
- 早期系统无统一权限约束，导致任意用户可访问全部功能。
- 本次实现 RBAC（Role-Based Access Control）：
  - 用户分配角色
  - 角色分配权限（来自菜单/按钮）
  - 前端菜单/按钮可见性控制
  - 后端接口强制鉴权

## 二、数据模型与关系
涉及表：
- **sys_user**：用户
- **sys_role**：角色
- **sys_menu**：菜单/按钮权限（DIR/MENU/BUTTON）
- **sys_role_menu**：角色与菜单权限关系
- **sys_user_role**：用户与角色关系

权限流转关系：
```
用户(sys_user)
  ↓ sys_user_role
角色(sys_role)
  ↓ sys_role_menu
菜单/按钮(sys_menu)
  → permission_code（权限标识）
```

### sys_menu 关键字段说明
- **menu_type**：DIR（目录）、MENU（页面菜单）、BUTTON（按钮权限）
- **permission_code**：权限标识，后端与前端统一使用
- **path/component**：前端路由与组件（MENU/DIR 才需要）

## 三、权限命名规范
权限标识采用三段式：
```
模块:资源:操作
```
示例：
- `system:user:add`
- `asset:info:edit`
- `inventory:execute`

## 四、本次改动说明
### 4.1 后端改动
- **UserDetailsServiceImpl**：登录后加载权限集合，写入 `UserDetailsImpl` 权限列表。
- **UserDetailsImpl**：对外提供 authorities，实现 Spring Security 权限校验。
- **PermissionChecker**：支持权限与“是否本人”校验的 SpEL 辅助。
- **Controller 权限注解**：新增/完善 `@PreAuthorize`，覆盖模块：
  - 系统：用户、角色、部门
  - 资产：资产信息、资产分类、流转记录
  - 生命周期：生命周期、盘点、报修
- 采购、账单统计、资金统计

### 4.2 前端改动
- 新增 **v-permission 指令**，统一控制按钮/菜单可见性。
- 路由增加 `meta.permission`，未授权自动跳转。
- 登录后初始化权限，退出登录清空权限缓存。
- 菜单按权限过滤展示，按钮按权限隐藏。

### 4.3 SQL 改动
- `sql/rbac_system.sql` 扩展了完整菜单/按钮权限树。
- 新增 **管理员全量权限初始化脚本**（本文附带说明）。
 - 财务管理入口、员工管理、资产分配管理已从权限树中移除；账单与资金统计挂载到采购管理。

## 五、权限清单（按模块）
### 5.1 仪表盘
- `dashboard:view`

### 5.2 系统管理
用户：
- `system:user:list` `system:user:view` `system:user:add` `system:user:edit`
- `system:user:delete` `system:user:status` `system:user:reset` `system:user:assign`

角色：
- `system:role:list` `system:role:view` `system:role:add` `system:role:edit`
- `system:role:delete` `system:role:status` `system:role:permission`

权限：
- `system:permission:list` `system:permission:add` `system:permission:edit`
- `system:permission:delete`

部门：
- `system:department:list` `system:department:view` `system:department:add`
- `system:department:edit` `system:department:delete`

### 5.3 资产管理
资产信息：
- `asset:info:list` `asset:info:view` `asset:info:edit`

流转记录：
- `asset:record:list` `asset:record:history`
- `asset:record:in` `asset:record:allocate` `asset:record:transfer`
- `asset:record:return` `asset:record:scrap` `asset:record:repair`

资产分类：
- `asset:category:list` `asset:category:view` `asset:category:add`
- `asset:category:edit` `asset:category:delete`

### 5.4 采购管理
- `purchase:list` `purchase:view` `purchase:create`
- `purchase:cancel`
 - `finance:bill:list` `finance:bill:view` `finance:bill:generate`
 - `finance:bill:confirm` `finance:bill:delete`
 - `finance:statistics:view`

### 5.5 生命周期与盘点
生命周期：
- `lifecycle:list` `lifecycle:create`
- `lifecycle:history` `lifecycle:current`

盘点：
- `inventory:list` `inventory:view` `inventory:create`
- `inventory:start` `inventory:execute` `inventory:complete` `inventory:cancel`

报修：
- `repair:list` `repair:view` `repair:create`
- `repair:approve` `repair:start` `repair:complete`

### 5.6 已移除模块说明
以下模块已从系统入口移除，不再分配权限：
- 财务管理（入口与采购记录模块已移除）
- 员工管理
- 资产分配管理

## 六、使用流程
### 6.1 初始化权限数据
适用于“只有用户表有数据，其它权限表为空”的场景：
1. 执行 `sql/admin_full_permission.sql`
2. 确认用户 `id=1` 已绑定 `ADMIN` 角色

> 若已有 RBAC 数据，请谨慎使用初始化脚本，避免覆盖。

### 6.2 角色管理
- 进入“角色管理”，新增/编辑角色。
- “分配权限”时勾选**菜单 + 按钮**，按钮权限未勾选将导致按钮不可见/接口受限。

### 6.3 用户管理
- 在“用户管理”中为用户分配角色。
- 角色变更后需重新登录，确保权限缓存刷新。

## 七、常见问题排查
1. **页面菜单不显示**  
   - 检查 `sys_menu.permission_code` 是否与前端路由 `meta.permission` 一致  
   - 确认该权限已分配给用户角色

2. **按钮不可见/接口 403**  
   - 检查按钮权限是否分配  
   - 后端 `@PreAuthorize` 是否存在对应权限标识

3. **权限已分配但仍不生效**  
   - 重新登录  
   - 确认权限加载接口 `GET /permission/user/{userId}/permissions` 返回包含该权限

## 八、扩展与维护建议
新增模块时遵循以下步骤：
1. 后端接口增加 `@PreAuthorize`  
2. 前端路由增加 `meta.permission`  
3. 前端按钮增加 `v-permission`  
4. 在 `sys_menu` 增加 MENU/BUTTON 权限标识  
5. 为角色分配权限并验证

## 九、参考资料
- `docs/RBAC权限加载与校验流程.md`（权限加载流程与接口说明）
