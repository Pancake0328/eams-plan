# 账单管理优化说明

## 优化内容

### 问题描述
原有的账单生成逻辑会将所有资产计入账单，即使资产的采购日期晚于账单期间。这导致账单数据不准确。

### 解决方案
在账单生成过程中添加了采购日期过滤逻辑，确保只计入在账单期间内已存在的资产。

## 核心逻辑

### 1. 月度账单过滤
```java
// 计算目标日期（该月最后一天）
LocalDate targetDate = LocalDate.of(year, month, 1).plusMonths(1).minusDays(1);

// 过滤：只包含采购日期不晚于账单日期的资产
List<DepreciationInfo> filteredList = depreciationList.stream()
        .filter(info -> {
            // 查询资产的采购记录
            LambdaQueryWrapper<AssetPurchase> purchaseWrapper = new LambdaQueryWrapper<>();
            purchaseWrapper.eq(AssetPurchase::getAssetId, info.getAssetId());
            purchaseWrapper.eq(AssetPurchase::getApprovalStatus, 1);
            purchaseWrapper.orderByAsc(AssetPurchase::getPurchaseDate);
            purchaseWrapper.last("LIMIT 1");
            AssetPurchase purchase = purchaseMapper.selectOne(purchaseWrapper);
            
            // 如果找不到采购记录或采购日期晚于账单日期，则不计入
            return purchase != null && !purchase.getPurchaseDate().isAfter(targetDate);
        })
        .toList();
```

### 2. 年度账单过滤
同样的逻辑应用于年度账单，目标日期为该年的12月31日。

## 过滤规则

1. **包含条件**：
   - 资产有已审批的采购记录（`approval_status = 1`）
   - 采购日期 ≤ 账单日期
   
2. **排除条件**：
   - 资产没有采购记录
   - 采购日期 > 账单日期

## 示例

### 场景1：2026年1月账单
- 账单日期：2026-01-31
- 资产A采购日期：2025-12-15 → ✅ 包含
- 资产B采购日期：2026-01-20 → ✅ 包含
- 资产C采购日期：2026-02-05 → ❌ 排除（采购日期晚于账单期间）

### 场景2：2025年度账单
- 账单日期：2025-12-31
- 资产D采购日期：2025-06-01 → ✅ 包含
- 资产E采购日期：2026-01-01 → ❌ 排除（采购日期晚于账单期间）

## 影响范围

### 修改的文件
- `AssetBillServiceImpl.java`
  - `generateMonthlyBill()` 方法
  - `generateAnnualBill()` 方法

### 新增依赖
- `AssetPurchase` 实体类
- `AssetPurchaseMapper` 接口

## 数据一致性

通过此优化：
1. **账单总额**：只包含账单期间内实际存在的资产
2. **账单明细**：每条明细都对应账单期间内的有效资产
3. **折旧计算**：基于实际持有时间计算，更加准确

## 性能考虑

过滤操作在内存中进行Stream处理，对于每个资产会执行一次数据库查询。
- 如果资产数量较大（>1000），建议优化为批量查询
- 当前实现适用于中小规模资产管理（<1000资产）

## 测试建议

1. **单元测试**：测试过滤逻辑的正确性
2. **集成测试**：测试账单生成的完整流程
3. **边界测试**：
   - 采购日期等于账单日期
   - 采购日期早于账单期间
   - 采购日期晚于账单期间
   - 无采购记录的资产
