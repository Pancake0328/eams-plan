# 企业资产管理系统（EAMS）技术文档

> **文档版本**：v1.0.0  
> **编写日期**：2025年  
> **适用范围**：企业资产管理系统全栈开发与运维团队  
> **文档状态**：正式发布

---

## 目录

1. [文档概述](#1-文档概述)
2. [系统架构设计](#2-系统架构设计)
3. [技术选型说明](#3-技术选型说明)
4. [后端设计](#4-后端设计)
5. [前端设计](#5-前端设计)
6. [数据库设计](#6-数据库设计)
7. [接口文档](#7-接口文档)
8. [安全设计](#8-安全设计)
9. [性能设计](#9-性能设计)
10. [部署设计](#10-部署设计)
11. [开发规范](#11-开发规范)

---

## 1. 文档概述

### 1.1 项目背景

企业资产管理系统（Enterprise Asset Management System，简称 EAMS）是一套面向企业内部的资产全生命周期数字化管理平台。系统覆盖资产从采购申请、入库登记、领用分配、调拨转移、维修保养、盘点核查到报废处置的完整业务闭环，帮助企业实现资产可视、可控、可追溯的精细化管理目标。

### 1.2 文档目的

本文档旨在：

- 向开发团队提供完整的系统设计说明，指导后续开发迭代；
- 向运维团队提供部署、配置和监控的操作依据；
- 向测试团队提供接口规范和业务逻辑的测试参考；
- 向项目管理层提供系统整体技术架构的概览。

### 1.3 系统功能概述

| 功能模块 | 主要功能描述 |
|----------|--------------|
| 系统管理 | 用户管理、角色管理、菜单权限管理、部门管理 |
| 资产管理 | 资产分类、资产信息录入与维护、资产流转记录 |
| 生命周期管理 | 资产盘点（计划与明细）、报修管理、生命周期追踪 |
| 采购管理 | 采购申请、采购单审批、采购明细管理 |
| 仪表盘 | 资产统计概览、分类分布、趋势图表 |
| 认证授权 | JWT登录鉴权、RBAC动态权限控制 |

### 1.4 技术栈概览

**后端**：Java 17 + Spring Boot 3.1.5 + MyBatis Plus 3.5.7 + MySQL 8.0 + Redis 6.0

**前端**：Vue 3.4.0 + TypeScript 5.3.3 + Element Plus 2.5.0 + Vite 5.0.8

**通信**：RESTful HTTP API + WebSocket

**安全**：Spring Security + JWT（JJWT 0.12.5）+ RBAC

---

## 2. 系统架构设计

### 2.1 总体架构

EAMS 采用前后端分离的多层架构模式，前端通过 HTTP RESTful API 与后端交互，后端负责业务逻辑处理、数据持久化与缓存管理。

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层（Client Tier）                   │
│                                                                   │
│   ┌───────────────────┐          ┌──────────────────────────┐    │
│   │   浏览器（PC端）    │          │      移动端/平板（未来）    │    │
│   │  Vue3 + TS + Vite  │          │                          │    │
│   └────────┬──────────┘          └──────────────────────────┘    │
└────────────┼────────────────────────────────────────────────────┘
             │ HTTPS / WebSocket
┌────────────▼────────────────────────────────────────────────────┐
│                      网关/代理层（Gateway Tier）                   │
│                                                                   │
│            ┌─────────────────────────────────────┐               │
│            │         Nginx 反向代理 / 负载均衡       │               │
│            │  ● 静态资源托管（前端构建产物）          │               │
│            │  ● API请求转发至后端服务               │               │
│            │  ● SSL 终止                           │               │
│            └──────────────────┬──────────────────┘               │
└───────────────────────────────┼─────────────────────────────────┘
                                │ HTTP
┌───────────────────────────────▼─────────────────────────────────┐
│                      应用层（Application Tier）                    │
│                                                                   │
│   ┌───────────────────────────────────────────────────────┐     │
│   │            Spring Boot 应用服务（端口 9998）              │     │
│   │                                                         │     │
│   │  ┌────────────┐  ┌────────────┐  ┌──────────────────┐  │     │
│   │  │ Controller │→ │  Service   │→ │  Mapper(MyBatis)  │  │     │
│   │  │   (REST)   │  │ (Business) │  │     (ORM)        │  │     │
│   │  └────────────┘  └─────┬──────┘  └────────┬─────────┘  │     │
│   │                        │                   │             │     │
│   │               ┌────────▼──────┐            │             │     │
│   │               │  Redis 缓存层  │            │             │     │
│   │               │  (Lettuce)    │            │             │     │
│   │               └───────────────┘            │             │     │
│   └─────────────────────────────────────────────┘            │     │
│                                                 │             │     │
└─────────────────────────────────────────────────┼────────────┘     │
                                                  │                   │
┌─────────────────────────────────────────────────▼───────────────┐
│                       数据层（Data Tier）                          │
│                                                                   │
│     ┌──────────────────────┐       ┌──────────────────────┐      │
│     │      MySQL 8.0        │       │      Redis 6.0        │      │
│     │  主数据库（端口 3306）  │       │  缓存数据库（端口 6379） │      │
│     │  ● HikariCP 连接池     │       │  ● 会话缓存            │      │
│     │  ● 16张业务表          │       │  ● 热点数据缓存         │      │
│     └──────────────────────┘       └──────────────────────┘      │
└───────────────────────────────────────────────────────────────────┘
```

### 2.2 技术架构分层

```
┌─────────────────────────────────────────────────────────┐
│  表现层（Presentation Layer）                              │
│  Vue3 组件 │ Element Plus UI │ ECharts 图表               │
├─────────────────────────────────────────────────────────┤
│  前端状态层（State Layer）                                  │
│  Pinia Store │ Vue Router（动态路由）│ Axios 请求拦截器      │
├─────────────────────────────────────────────────────────┤
│  接口层（API Layer）                                        │
│  RESTful Controller │ SpringDoc Swagger │ WebSocket       │
├─────────────────────────────────────────────────────────┤
│  安全层（Security Layer）                                   │
│  Spring Security │ JWT Filter │ RBAC 权限校验               │
├─────────────────────────────────────────────────────────┤
│  业务层（Business Layer）                                   │
│  Service Interface │ Service Impl │ AOP 操作日志            │
├─────────────────────────────────────────────────────────┤
│  数据访问层（Data Access Layer）                             │
│  MyBatis Plus Mapper │ QueryWrapper │ 动态SQL               │
├─────────────────────────────────────────────────────────┤
│  基础设施层（Infrastructure Layer）                          │
│  MySQL │ Redis │ HikariCP │ Lettuce │ MapStruct │ Hutool  │
└─────────────────────────────────────────────────────────┘
```

### 2.3 部署架构

```
                        ┌─────────────────┐
                        │   用户浏览器      │
                        └────────┬────────┘
                                 │ HTTPS:443
                        ┌────────▼────────┐
                        │   Nginx 服务器   │
                        │   (反向代理)     │
                        └──┬──────────┬───┘
                           │          │
               /api/*      │          │  /* (静态资源)
                  ┌────────▼────┐  ┌──▼──────────────┐
                  │  Spring Boot │  │  前端静态文件     │
                  │  :9998       │  │  dist/           │
                  └──────┬───────┘  └─────────────────┘
                         │
               ┌─────────┴──────────┐
               │                    │
      ┌────────▼────────┐  ┌────────▼────────┐
      │   MySQL :3306    │  │   Redis :6379    │
      └─────────────────┘  └─────────────────┘
```

### 2.4 安全架构

```
请求进入 → Nginx SSL 终止
    │
    ▼
Spring Security Filter Chain
    │
    ├─→ [白名单路径] → 直接放行（/api/auth/login, /swagger-ui/**）
    │
    └─→ [受保护路径]
            │
            ▼
       JWT Token 校验
            │
            ├─→ [Token 无效/过期] → 401 Unauthorized
            │
            └─→ [Token 有效] → 解析用户信息存入 SecurityContext
                        │
                        ▼
                 RBAC 权限校验
                        │
                        ├─→ [无权限] → 403 Forbidden
                        │
                        └─→ [有权限] → 进入 Controller 处理
                                    │
                                    ▼
                              AOP 操作日志记录
```

---

## 3. 技术选型说明

### 3.1 后端技术选型

#### 3.1.1 Java 17（LTS）

**选型理由**：
- Java 17 是目前生产环境最广泛使用的 LTS 版本，获得 Oracle 长期支持至 2029 年；
- 引入 Record 类、密封类（Sealed Classes）、文本块等语法糖，提高代码可读性；
- ZGC / G1GC 等垃圾收集器成熟稳定，低延迟表现优秀；
- Spring Boot 3.x 要求最低 Java 17，与项目技术栈完全匹配。

#### 3.1.2 Spring Boot 3.1.5

**选型理由**：
- 基于 Spring Framework 6，原生支持 Jakarta EE 10 命名空间；
- 自动配置机制大幅减少样板代码，开箱即用；
- 生态完善，与 Spring Security、Spring Data、Spring AOP 无缝集成；
- 内嵌 Tomcat，简化部署流程；
- Actuator 提供生产级健康检查与监控端点。

#### 3.1.3 MyBatis Plus 3.5.7

**选型理由**：
- 在 MyBatis 基础上增强，保留原生 SQL 灵活性的同时提供 CRUD 自动化；
- `QueryWrapper` / `LambdaQueryWrapper` 构建类型安全的动态查询，避免 SQL 注入；
- 内置分页插件（`PaginationInterceptor`），无需手写 LIMIT 逻辑；
- 逻辑删除、字段自动填充（`@TableField(fill=...)`）等特性适合企业级开发；
- 相比 JPA/Hibernate，SQL 可见性更高，便于 DBA 审计与优化。

#### 3.1.4 JJWT 0.12.5

**选型理由**：
- Java 生态中最成熟的 JWT 库，API 简洁；
- 支持 HS256、RS256 等多种签名算法；
- 0.12.x 版本 API 重构，安全性更强；
- 7天有效期配置满足企业系统使用场景，平衡安全性与用户体验。

#### 3.1.5 Redis 6.0 + Lettuce

**选型理由**：
- Lettuce 是 Spring Data Redis 默认客户端，支持响应式编程，线程安全；
- Redis 6.0 引入 ACL 权限控制和多线程 I/O，性能与安全性显著提升；
- 用于会话缓存、热点数据缓存，减轻 MySQL 读压力；
- 支持分布式锁，为后续水平扩展预留能力。

#### 3.1.6 Apache POI 5.2.5

**选型理由**：
- Java 生态中处理 Office 文档的事实标准库；
- 支持 xlsx（SXSSF 流式写入）格式，处理大数据量 Excel 导出时内存友好；
- 资产数据批量导入导出是企业系统的核心需求，POI 能力完全覆盖。

### 3.2 前端技术选型

#### 3.2.1 Vue 3.4.0 + TypeScript 5.3.3

**选型理由**：
- Vue 3 Composition API 使逻辑复用更灵活，`<script setup>` 语法减少模板代码；
- TypeScript 提供类型安全，在大型项目中显著减少运行时错误；
- Vue 3.4 引入 `defineModel` 宏，简化双向绑定，减少父子组件通信模板代码；
- 与 Element Plus、Pinia 等生态库完美适配。

#### 3.2.2 Vite 5.0.8

**选型理由**：
- 基于原生 ES Module，开发环境冷启动时间毫秒级（相比 Webpack 减少 90%+）；
- HMR（热模块替换）几乎无延迟；
- 生产构建基于 Rollup，产物体积优化良好。

#### 3.2.3 Element Plus 2.5.0

**选型理由**：
- 专为 Vue 3 设计的企业级 UI 组件库，组件丰富（表格、表单、弹窗、日期选择等）；
- 满足企业管理系统对复杂表单与数据表格的需求；
- 主题定制能力强，支持 CSS 变量覆盖。

#### 3.2.4 Pinia 2.1.7

**选型理由**：
- Vue 官方推荐的状态管理库，替代 Vuex 4；
- 无 mutations 概念，API 更直觉化；
- TypeScript 类型推导完善，无需额外类型声明；
- 支持 DevTools 调试，方便开发调试状态变化。

#### 3.2.5 ECharts 6.0.0（数据可视化）

**选型理由**：
- Apache 顶级项目，图表类型丰富，适配仪表盘各类统计图需求；
- 渲染性能优秀，支持大数据量渲染；
- 与 Vue 3 集成简单，通过 `resize` 事件响应容器尺寸变化。

---

## 4. 后端设计

### 4.1 模块划分

```
src/main/java/com/eams/
├── EamsApplication.java              # Spring Boot 主启动类
│
├── aop/                              # AOP 切面
│   └── OperationLogAspect.java       # 操作日志切面（@Around）
│
├── asset/                            # 资产核心模块
│   ├── controller/
│   │   ├── AssetCategoryController.java   # 资产分类接口
│   │   ├── AssetInfoController.java       # 资产信息 CRUD 接口
│   │   └── AssetRecordController.java     # 资产流转记录接口
│   ├── dto/
│   │   ├── AssetInfoDTO.java              # 资产信息传输对象
│   │   └── AssetTransferDTO.java          # 资产调拨传输对象
│   ├── entity/
│   │   ├── AssetCategory.java             # 资产分类实体
│   │   ├── AssetInfo.java                 # 资产信息实体
│   │   ├── AssetRecord.java               # 资产流转记录实体
│   │   └── AssetNumberSequence.java       # 资产编号序列实体
│   ├── mapper/
│   │   ├── AssetCategoryMapper.java
│   │   ├── AssetInfoMapper.java
│   │   └── AssetRecordMapper.java
│   ├── service/
│   │   ├── AssetInfoService.java          # 服务接口
│   │   └── impl/AssetInfoServiceImpl.java # 服务实现
│   └── vo/
│       └── AssetInfoVO.java               # 资产信息视图对象
│
├── common/                           # 通用模块
│   ├── Result.java                   # 统一响应包装类 Result<T>
│   ├── PageResult.java               # 分页响应包装类
│   └── enums/
│       ├── AssetStatus.java          # 资产状态枚举
│       └── RecordType.java           # 流转类型枚举
│
├── config/                           # 配置类
│   ├── CorsConfig.java               # 跨域配置
│   ├── RedisConfig.java              # Redis 序列化配置
│   ├── MybatisPlusConfig.java        # 分页插件配置
│   ├── SwaggerConfig.java            # SpringDoc OpenAPI 配置
│   └── WebSocketConfig.java          # WebSocket 配置
│
├── dashboard/                        # 仪表盘模块
│   └── controller/DashboardController.java
│
├── exception/                        # 异常处理
│   ├── BusinessException.java        # 业务异常类
│   └── GlobalExceptionHandler.java   # 全局异常处理器（@RestControllerAdvice）
│
├── lifecycle/                        # 生命周期管理模块
│   ├── controller/
│   │   ├── AssetInventoryController.java  # 资产盘点接口
│   │   └── AssetRepairController.java     # 报修管理接口
│   ├── entity/
│   │   ├── AssetInventory.java            # 盘点计划实体
│   │   ├── AssetInventoryDetail.java      # 盘点明细实体
│   │   ├── AssetLifecycle.java            # 生命周期实体
│   │   └── AssetRepair.java               # 报修记录实体
│   └── ...
│
├── purchase/                         # 采购管理模块
│   ├── entity/
│   │   ├── PurchaseOrder.java             # 采购单实体
│   │   └── PurchaseOrderDetail.java       # 采购明细实体
│   └── ...
│
├── security/                         # 安全模块
│   ├── JwtAuthenticationFilter.java   # JWT 认证过滤器
│   ├── JwtUtils.java                  # JWT 工具类
│   ├── CustomUserDetailsService.java  # 用户详情服务
│   └── SecurityConfig.java            # Spring Security 配置
│
└── system/                           # 系统管理模块
    ├── entity/
    │   ├── User.java                  # 用户实体
    │   ├── SysRole.java               # 角色实体
    │   ├── SysMenu.java               # 菜单权限实体
    │   ├── Department.java            # 部门实体
    │   ├── SysRoleMenu.java           # 角色菜单关联
    │   └── SysUserRole.java           # 用户角色关联
    └── ...
```

### 4.2 统一响应格式

所有接口使用 `Result<T>` 包装响应，确保前端处理的一致性：

```java
@Data
public class Result<T> {
    private Integer code;      // 业务状态码：200成功，400参数错误，401未认证，403无权限，500系统错误
    private String message;    // 响应消息
    private T data;            // 响应数据
    private Long timestamp;    // 响应时间戳

    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("操作成功");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }

    public static <T> Result<T> error(String message) {
        Result<T> result = new Result<>();
        result.setCode(500);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }

    public static <T> Result<T> error(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
}
```

### 4.3 分页响应格式

```java
@Data
public class PageResult<T> {
    private List<T> records;   // 当前页数据列表
    private Long total;        // 总记录数
    private Long current;      // 当前页码
    private Long size;         // 每页条数
    private Long pages;        // 总页数
}
```

### 4.4 AOP 操作日志设计

操作日志通过 AOP 切面自动记录，无需在 Service 层手动调用，保证代码侵入性最低：

```java
@Aspect
@Component
@Slf4j
public class OperationLogAspect {

    // 切入点：所有标注 @OperationLog 注解的方法
    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint point, OperationLog operationLog) throws Throwable {
        long startTime = System.currentTimeMillis();
        // 获取当前登录用户
        String username = SecurityContextHolder.getContext()
                .getAuthentication().getName();
        Object result = null;
        try {
            result = point.proceed();
            // 记录成功日志
            saveLog(username, operationLog.module(), operationLog.operation(),
                    System.currentTimeMillis() - startTime, "SUCCESS", null);
        } catch (Exception e) {
            // 记录失败日志
            saveLog(username, operationLog.module(), operationLog.operation(),
                    System.currentTimeMillis() - startTime, "FAIL", e.getMessage());
            throw e;
        }
        return result;
    }
}
```

### 4.5 全局异常处理

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.warn("业务异常: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<Void> handleValidException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));
        return Result.error(400, message);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public Result<Void> handleAccessDeniedException(AccessDeniedException e) {
        return Result.error(403, "暂无权限访问");
    }

    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.error(500, "系统内部错误，请联系管理员");
    }
}
```

### 4.6 API 设计规范

| 规范项 | 说明 |
|--------|------|
| 路径风格 | 全小写，单词以 `-` 连接，`/api/{模块}/{资源}` |
| HTTP 动词 | GET 查询，POST 新增，PUT 全量更新，PATCH 部分更新，DELETE 删除 |
| 版本控制 | 路径前缀 `/api/v1/`（当前为 v1） |
| 分页参数 | `current`（页码，默认1），`size`（每页条数，默认10） |
| 响应码 | 统一返回 HTTP 200，业务结果通过 `code` 字段区分 |
| 时间格式 | ISO 8601：`yyyy-MM-dd HH:mm:ss` |

**接口路径示例**：

```
GET    /api/asset/info                    # 分页查询资产列表
GET    /api/asset/info/{id}               # 查询单个资产
POST   /api/asset/info                    # 新增资产
PUT    /api/asset/info/{id}               # 更新资产
DELETE /api/asset/info/{id}               # 删除资产
POST   /api/asset/info/import             # Excel 批量导入
GET    /api/asset/info/export             # Excel 导出
GET    /api/asset/category/tree           # 查询分类树
POST   /api/auth/login                    # 用户登录
POST   /api/auth/logout                   # 用户退出
GET    /api/auth/userinfo                 # 获取当前用户信息
GET    /api/system/menu/routes            # 获取当前用户路由菜单
```

---

## 5. 前端设计

### 5.1 目录结构

```
frontend/src/
├── api/                          # API 接口封装层
│   ├── auth.ts                   # 认证相关接口
│   ├── asset.ts                  # 资产管理接口
│   ├── system.ts                 # 系统管理接口
│   ├── lifecycle.ts              # 生命周期接口
│   ├── purchase.ts               # 采购管理接口
│   └── dashboard.ts              # 仪表盘接口
│
├── components/                   # 公共组件
│   ├── IconSelect/               # 图标选择器
│   ├── ECharts/                  # ECharts 封装组件
│   └── UploadExcel/              # Excel 上传组件
│
├── directives/                   # 自定义指令
│   └── permission.ts             # v-permission 权限指令
│
├── layout/                       # 全局布局
│   ├── index.vue                 # 主布局（Sidebar + Header + Main）
│   ├── Sidebar/                  # 侧边栏组件
│   ├── Header/                   # 顶部导航组件
│   └── Tagsview/                 # 标签页导航
│
├── router/                       # 路由配置
│   ├── index.ts                  # 路由实例，包含全局守卫
│   └── routes.ts                 # 静态路由定义（登录页等）
│
├── stores/                       # Pinia 状态管理
│   ├── auth.ts                   # 认证状态（token、userinfo、permissions）
│   ├── menu.ts                   # 菜单与动态路由状态
│   └── app.ts                    # 应用全局状态（主题、侧边栏折叠等）
│
├── types/                        # TypeScript 类型定义
│   ├── api.d.ts                  # API 响应类型
│   ├── asset.d.ts                # 资产相关类型
│   └── system.d.ts               # 系统相关类型
│
├── utils/                        # 工具函数
│   ├── request.ts                # Axios 实例与拦截器
│   ├── auth.ts                   # Token 存储工具
│   └── format.ts                 # 日期、金额格式化工具
│
└── views/                        # 页面视图组件（14个页面）
    ├── login/                    # 登录页
    ├── dashboard/                # 仪表盘
    ├── asset/
    │   ├── category/             # 资产分类
    │   ├── info/                 # 资产信息管理
    │   └── record/               # 资产流转记录
    ├── lifecycle/
    │   ├── inventory/            # 资产盘点
    │   └── repair/               # 报修管理
    ├── purchase/                 # 采购管理
    └── system/
        ├── user/                 # 用户管理
        ├── role/                 # 角色管理
        ├── menu/                 # 菜单管理
        └── department/           # 部门管理
```

### 5.2 Axios 请求封装

```typescript
// utils/request.ts
import axios, { type AxiosInstance, type AxiosRequestConfig } from 'axios'
import { ElMessage } from 'element-plus'
import { useAuthStore } from '@/stores/auth'
import router from '@/router'

const request: AxiosInstance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 15000,
  headers: { 'Content-Type': 'application/json' }
})

// 请求拦截器：自动注入 JWT Token
request.interceptors.request.use(config => {
  const authStore = useAuthStore()
  if (authStore.token) {
    config.headers.Authorization = `Bearer ${authStore.token}`
  }
  return config
})

// 响应拦截器：统一处理业务错误
request.interceptors.response.use(
  response => {
    const { code, message, data } = response.data
    if (code === 200) return data
    if (code === 401) {
      useAuthStore().clearAuth()
      router.push('/login')
    }
    ElMessage.error(message || '请求失败')
    return Promise.reject(new Error(message))
  },
  error => {
    ElMessage.error(error.response?.data?.message || '网络异常，请稍后重试')
    return Promise.reject(error)
  }
)

export default request
```

### 5.3 动态路由设计

登录成功后从后端获取当前用户的菜单权限，动态生成路由：

```
登录成功
    │
    ▼
调用 /api/system/menu/routes
    │
    ▼
后端返回用户有权限的菜单树（含 component 路径）
    │
    ▼
前端遍历菜单树，动态 import() 对应 .vue 组件
    │
    ▼
router.addRoute() 动态注册路由
    │
    ▼
Pinia menuStore 保存菜单列表，用于渲染侧边栏
```

### 5.4 权限指令

```typescript
// directives/permission.ts
import type { DirectiveBinding } from 'vue'
import { useAuthStore } from '@/stores/auth'

export const vPermission = {
  mounted(el: HTMLElement, binding: DirectiveBinding<string | string[]>) {
    const authStore = useAuthStore()
    const permissions = authStore.permissions
    const required = Array.isArray(binding.value) ? binding.value : [binding.value]
    const hasPermission = required.some(p => permissions.includes(p))
    if (!hasPermission) {
      el.parentNode?.removeChild(el)  // 无权限则从 DOM 中移除元素
    }
  }
}

// 使用示例
// <el-button v-permission="'asset:info:add'">新增资产</el-button>
// <el-button v-permission="['asset:info:edit', 'asset:info:admin']">编辑</el-button>
```

### 5.5 Pinia 状态管理设计

```typescript
// stores/auth.ts
import { defineStore } from 'pinia'
import { getUserInfo, login, logout } from '@/api/auth'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    token: localStorage.getItem('eams_token') || '',
    userInfo: null as UserInfo | null,
    permissions: [] as string[],   // 权限标识列表，如 ['asset:info:add', 'system:user:list']
    roles: [] as string[]          // 角色标识列表
  }),

  getters: {
    isLoggedIn: state => !!state.token,
    hasPermission: state => (permission: string) =>
      state.permissions.includes(permission) || state.roles.includes('admin')
  },

  actions: {
    async loginAction(loginForm: LoginForm) {
      const { token } = await login(loginForm)
      this.token = token
      localStorage.setItem('eams_token', token)
      await this.fetchUserInfo()
    },

    async fetchUserInfo() {
      const data = await getUserInfo()
      this.userInfo = data.userInfo
      this.permissions = data.permissions
      this.roles = data.roles
    },

    clearAuth() {
      this.token = ''
      this.userInfo = null
      this.permissions = []
      this.roles = []
      localStorage.removeItem('eams_token')
    }
  }
})
```

---

## 6. 数据库设计

### 6.1 ER 关系图（核心实体）

```
┌──────────────┐     N:M     ┌──────────────┐     N:M     ┌──────────────┐
│   sys_user    │─────────────│  sys_user_   │─────────────│   sys_role    │
│              │             │    role      │             │              │
│  id          │             │  user_id     │             │  id          │
│  username    │             │  role_id     │             │  role_name   │
│  password    │             └──────────────┘             │  role_code   │
│  dept_id     │                                          └──────┬───────┘
│  ...         │                                                 │ N:M
└──────┬───────┘                                          ┌──────▼───────┐
       │ N:1                                              │ sys_role_menu │
       │                                                  │  role_id     │
┌──────▼───────┐                                          │  menu_id     │
│  department   │                                          └──────┬───────┘
│              │                                                 │ N:1
│  id          │                                          ┌──────▼───────┐
│  dept_name   │                                          │   sys_menu    │
│  parent_id   │                                          │              │
└──────────────┘                                          │  id          │
                                                          │  menu_name   │
                                                          │  permission  │
                                                          │  parent_id   │
                                                          └──────────────┘

┌──────────────┐    1:N     ┌──────────────┐    N:1    ┌──────────────────┐
│asset_category│────────────│  asset_info  │────────── │    department     │
│              │            │              │           │                  │
│  id          │            │  id          │           │  id              │
│  category_   │            │  asset_      │           │  dept_name       │
│  name        │            │  number      │           └──────────────────┘
│  parent_id   │            │  asset_name  │
└──────────────┘            │  category_id │            N:1  ┌─────────────┐
                            │  dept_id     │────────────────│  sys_user   │
                            │  custodian   │                 │  (保管人)    │
                            │  asset_      │                 └─────────────┘
                            │  status      │
                            └──────┬───────┘
                                   │ 1:N
              ┌────────────────────┼───────────────────────┐
              │                    │                       │
    ┌─────────▼──────┐  ┌──────────▼──────┐  ┌────────────▼───────┐
    │  asset_record  │  │ asset_lifecycle  │  │   asset_repair     │
    │  (流转记录)     │  │  (生命周期)       │  │   (报修记录)        │
    └────────────────┘  └─────────────────┘  └────────────────────┘

┌──────────────────────┐    1:N    ┌─────────────────────────┐
│  asset_purchase_     │──────────│ asset_purchase_order_   │
│  order（采购单）       │          │ detail（采购明细）         │
└──────────────────────┘          └─────────────────────────┘

┌──────────────────────┐    1:N    ┌─────────────────────────┐
│  asset_inventory     │──────────│ asset_inventory_detail  │
│  （盘点计划）          │          │ （盘点明细）               │
└──────────────────────┘          └─────────────────────────┘
```

### 6.2 核心表结构

#### 6.2.1 用户表（sys_user）

```sql
CREATE TABLE `sys_user` (
  `id`          BIGINT       NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username`    VARCHAR(50)  NOT NULL COMMENT '用户名（登录账号）',
  `password`    VARCHAR(100) NOT NULL COMMENT '密码（BCrypt加密）',
  `real_name`   VARCHAR(50)           COMMENT '真实姓名',
  `email`       VARCHAR(100)          COMMENT '邮箱',
  `phone`       VARCHAR(20)           COMMENT '手机号',
  `dept_id`     BIGINT                COMMENT '所属部门ID',
  `avatar`      VARCHAR(255)          COMMENT '头像URL',
  `status`      TINYINT      NOT NULL DEFAULT 1 COMMENT '状态：1启用，0禁用',
  `create_time` DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`     TINYINT      NOT NULL DEFAULT 0 COMMENT '逻辑删除：0未删，1已删',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_dept_id` (`dept_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';
```

#### 6.2.2 资产信息表（asset_info）

```sql
CREATE TABLE `asset_info` (
  `id`              BIGINT         NOT NULL AUTO_INCREMENT COMMENT '资产ID',
  `asset_number`    VARCHAR(30)    NOT NULL COMMENT '资产编号（系统自动生成，格式：YYYYMM+4位序号）',
  `asset_name`      VARCHAR(100)   NOT NULL COMMENT '资产名称',
  `category_id`     BIGINT         NOT NULL COMMENT '资产分类ID',
  `purchase_amount` DECIMAL(15,2)           COMMENT '采购金额（元）',
  `purchase_date`   DATE                    COMMENT '采购日期',
  `dept_id`         BIGINT                  COMMENT '所属部门ID',
  `custodian`       BIGINT                  COMMENT '保管人用户ID',
  `asset_status`    VARCHAR(20)    NOT NULL DEFAULT 'IDLE'
                    COMMENT '资产状态：IDLE闲置，IN_USE使用中，MAINTENANCE维修中，SCRAPPED已报废，TRANSFERRED已调拨',
  `specifications`  VARCHAR(500)            COMMENT '规格型号',
  `manufacturer`    VARCHAR(100)            COMMENT '生产厂商',
  `location`        VARCHAR(200)            COMMENT '存放位置',
  `remark`          TEXT                    COMMENT '备注',
  `create_time`     DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time`     DATETIME       NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted`         TINYINT        NOT NULL DEFAULT 0 COMMENT '逻辑删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_asset_number` (`asset_number`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_dept_id` (`dept_id`),
  KEY `idx_custodian` (`custodian`),
  KEY `idx_asset_status` (`asset_status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资产信息表';
```

#### 6.2.3 资产流转记录表（asset_record）

```sql
CREATE TABLE `asset_record` (
  `id`              BIGINT       NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `asset_id`        BIGINT       NOT NULL COMMENT '资产ID',
  `record_type`     VARCHAR(30)  NOT NULL
                    COMMENT '流转类型：IN_STORAGE入库，OUT_STORAGE出库，TRANSFER调拨，REPAIR维修，RETURN归还，SCRAP报废',
  `from_dept_id`    BIGINT                COMMENT '来源部门ID',
  `to_dept_id`      BIGINT                COMMENT '目标部门ID',
  `from_user_id`    BIGINT                COMMENT '来源保管人ID',
  `to_user_id`      BIGINT                COMMENT '目标保管人ID',
  `operator_id`     BIGINT       NOT NULL COMMENT '操作人ID',
  `operate_time`    DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  `remark`          VARCHAR(500)          COMMENT '备注说明',
  `create_time`     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_asset_id` (`asset_id`),
  KEY `idx_record_type` (`record_type`),
  KEY `idx_operate_time` (`operate_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资产流转记录表';
```

#### 6.2.4 盘点计划表（asset_inventory）

```sql
CREATE TABLE `asset_inventory` (
  `id`              BIGINT       NOT NULL AUTO_INCREMENT COMMENT '盘点ID',
  `inventory_name`  VARCHAR(100) NOT NULL COMMENT '盘点名称',
  `dept_id`         BIGINT                COMMENT '盘点部门（为空表示全公司）',
  `plan_start_date` DATE         NOT NULL COMMENT '计划开始日期',
  `plan_end_date`   DATE         NOT NULL COMMENT '计划结束日期',
  `actual_end_date` DATE                  COMMENT '实际结束日期',
  `status`          VARCHAR(20)  NOT NULL DEFAULT 'PENDING'
                    COMMENT '盘点状态：PENDING待开始，IN_PROGRESS盘点中，COMPLETED已完成，CANCELLED已取消',
  `creator_id`      BIGINT       NOT NULL COMMENT '创建人ID',
  `remark`          VARCHAR(500)          COMMENT '备注',
  `create_time`     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time`     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_dept_id` (`dept_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资产盘点计划表';
```

### 6.3 索引设计原则

| 原则 | 说明 |
|------|------|
| 高频查询字段建索引 | `asset_status`、`category_id`、`dept_id` 等常用过滤字段 |
| 唯一性约束 | `asset_number` 使用 UNIQUE KEY 保证资产编号唯一性 |
| 联合索引顺序 | 遵循最左前缀原则，高区分度字段放前 |
| 避免过度索引 | 写多读少的表（如 `asset_record`）控制索引数量 |
| 时间范围索引 | `create_time`、`operate_time` 建索引支持时间范围查询 |

### 6.4 数据规范

- **字符集**：统一使用 `utf8mb4`，字符集排序规则 `utf8mb4_unicode_ci`，支持 emoji；
- **逻辑删除**：所有业务表包含 `deleted` 字段（0未删/1已删），MyBatis Plus 自动过滤；
- **时间字段**：`create_time` 和 `update_time` 由数据库 DEFAULT + ON UPDATE 自动维护；
- **金额字段**：使用 `DECIMAL(15,2)` 类型，禁止使用 FLOAT/DOUBLE 以避免精度丢失；
- **枚举字段**：使用 VARCHAR 存储枚举值字符串（如 `'IDLE'`），便于可读性，禁止使用数字代码；
- **主键策略**：使用 `BIGINT AUTO_INCREMENT`，为后续分库分表预留 SNOWFLAKE ID 替换空间。

---

## 7. 接口文档

### 7.1 认证接口

#### 7.1.1 用户登录

```
POST /api/auth/login
Content-Type: application/json
```

**请求体**：

```json
{
  "username": "admin",
  "password": "Admin@123"
}
```

**响应示例（成功）**：

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expireTime": 1735660800000
  },
  "timestamp": 1735574400000
}
```

**响应示例（失败）**：

```json
{
  "code": 401,
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": 1735574400000
}
```

#### 7.1.2 获取当前用户信息

```
GET /api/auth/userinfo
Authorization: Bearer {token}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "userInfo": {
      "id": 1,
      "username": "admin",
      "realName": "系统管理员",
      "email": "admin@eams.com",
      "deptId": 1,
      "deptName": "信息技术部"
    },
    "roles": ["admin"],
    "permissions": [
      "asset:info:list", "asset:info:add", "asset:info:edit",
      "asset:info:delete", "system:user:list", "system:role:list"
    ]
  }
}
```

### 7.2 资产管理接口

#### 7.2.1 分页查询资产列表

```
GET /api/asset/info?current=1&size=10&assetName=&categoryId=&assetStatus=&deptId=
Authorization: Bearer {token}
```

**查询参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| current | Integer | 否 | 当前页码，默认1 |
| size | Integer | 否 | 每页条数，默认10，最大100 |
| assetName | String | 否 | 资产名称模糊搜索 |
| assetNumber | String | 否 | 资产编号精确搜索 |
| categoryId | Long | 否 | 资产分类ID |
| assetStatus | String | 否 | 资产状态（IDLE/IN_USE/MAINTENANCE/SCRAPPED） |
| deptId | Long | 否 | 所属部门ID |

**响应示例**：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [
      {
        "id": 101,
        "assetNumber": "202501001",
        "assetName": "联想ThinkPad E14笔记本",
        "categoryId": 5,
        "categoryName": "计算机设备",
        "purchaseAmount": 6800.00,
        "purchaseDate": "2025-01-15",
        "deptId": 3,
        "deptName": "研发部",
        "custodian": 12,
        "custodianName": "张三",
        "assetStatus": "IN_USE",
        "specifications": "Intel i7-1255U, 16GB RAM, 512GB SSD",
        "manufacturer": "联想",
        "location": "3楼研发区-工位A23",
        "createTime": "2025-01-15 09:30:00"
      }
    ],
    "total": 328,
    "current": 1,
    "size": 10,
    "pages": 33
  }
}
```

#### 7.2.2 新增资产

```
POST /api/asset/info
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**：

```json
{
  "assetName": "联想ThinkPad E14笔记本",
  "categoryId": 5,
  "purchaseAmount": 6800.00,
  "purchaseDate": "2025-01-15",
  "deptId": 3,
  "custodian": 12,
  "specifications": "Intel i7-1255U, 16GB RAM, 512GB SSD",
  "manufacturer": "联想",
  "location": "3楼研发区-工位A23",
  "remark": "新员工入职配发"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "资产新增成功",
  "data": {
    "id": 102,
    "assetNumber": "202501002"
  }
}
```

#### 7.2.3 资产状态流转

```
PATCH /api/asset/info/{id}/status
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**：

```json
{
  "targetStatus": "MAINTENANCE",
  "remark": "屏幕出现条纹，送修"
}
```

### 7.3 仪表盘接口

#### 7.3.1 获取统计概览

```
GET /api/dashboard/overview
Authorization: Bearer {token}
```

**响应示例**：

```json
{
  "code": 200,
  "data": {
    "totalAssets": 1286,
    "totalValue": 3680000.00,
    "idleCount": 243,
    "inUseCount": 891,
    "maintenanceCount": 32,
    "scrappedCount": 120,
    "thisMonthAdded": 15,
    "thisMonthScrapped": 3
  }
}
```

#### 7.3.2 资产分类分布

```
GET /api/dashboard/category-distribution
Authorization: Bearer {token}
```

**响应示例**：

```json
{
  "code": 200,
  "data": [
    { "categoryName": "计算机设备", "count": 456, "percentage": 35.5 },
    { "categoryName": "办公设备", "count": 312, "percentage": 24.3 },
    { "categoryName": "通信设备", "count": 198, "percentage": 15.4 },
    { "categoryName": "家具陈设", "count": 187, "percentage": 14.5 },
    { "categoryName": "其他", "count": 133, "percentage": 10.3 }
  ]
}
```

### 7.4 Excel 导入导出接口

#### 7.4.1 资产批量导入

```
POST /api/asset/info/import
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [Excel 文件，.xlsx格式，最大10MB]
```

**响应示例（部分成功）**：

```json
{
  "code": 200,
  "data": {
    "totalRows": 50,
    "successCount": 47,
    "failCount": 3,
    "failDetails": [
      { "row": 5, "reason": "资产名称不能为空" },
      { "row": 12, "reason": "资产分类不存在：电子设备XX" },
      { "row": 28, "reason": "采购金额格式错误" }
    ]
  }
}
```

#### 7.4.2 资产数据导出

```
GET /api/asset/info/export?assetStatus=IN_USE&deptId=3
Authorization: Bearer {token}
```

响应为 Excel 文件流（`application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`）。

---

## 8. 安全设计

### 8.1 JWT 认证流程

```
客户端                                    服务端
  │                                          │
  │   POST /api/auth/login                   │
  │   {username, password}                   │
  │─────────────────────────────────────────▶│
  │                                          │
  │                              1. 查询用户信息
  │                              2. BCrypt.matches() 校验密码
  │                              3. 生成 JWT Token（有效期7天）
  │                              4. 将用户权限信息存入 Redis（key: token:userId）
  │                                          │
  │   200 OK: {token, expireTime}            │
  │◀─────────────────────────────────────────│
  │                                          │
  │   GET /api/asset/info                    │
  │   Authorization: Bearer {token}          │
  │─────────────────────────────────────────▶│
  │                                          │
  │                              1. JwtAuthenticationFilter 拦截
  │                              2. 解析 JWT，验证签名和过期时间
  │                              3. 从 JWT Claims 中提取 userId
  │                              4. 从 Redis 或 DB 加载用户权限
  │                              5. 构建 UsernamePasswordAuthenticationToken
  │                              6. 存入 SecurityContextHolder
  │                              7. 进入 Controller 处理业务
  │                                          │
  │   200 OK: {data}                         │
  │◀─────────────────────────────────────────│
```

### 8.2 JWT 核心配置

```java
// JWT 配置
@Component
public class JwtUtils {
    @Value("${jwt.secret}")
    private String secret;                   // 从配置文件读取，不硬编码

    private static final long EXPIRE_TIME = 7 * 24 * 60 * 60 * 1000L;  // 7天（毫秒）

    public String generateToken(Long userId, String username) {
        Date expireDate = new Date(System.currentTimeMillis() + EXPIRE_TIME);
        return Jwts.builder()
                .subject(userId.toString())
                .claim("username", username)
                .issuedAt(new Date())
                .expiration(expireDate)
                .signWith(Keys.hmacShaKeyFor(secret.getBytes()), Jwts.SIG.HS256)
                .compact();
    }

    public Claims parseToken(String token) {
        return Jwts.parser()
                .verifyWith(Keys.hmacShaKeyFor(secret.getBytes()))
                .build()
                .parseSignedClaims(token)
                .getPayload();
    }
}
```

**application.yml 安全配置**：

```yaml
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-key-replace-in-production}
  # 生产环境通过环境变量 JWT_SECRET 注入，禁止在配置文件中硬编码密钥
```

### 8.3 RBAC 权限模型

```
用户（User）
    │
    │ N:M（通过 sys_user_role）
    ▼
角色（Role）
    │
    │ N:M（通过 sys_role_menu）
    ▼
菜单/权限（Menu）
    │
    ├── type=0（目录）：侧边栏目录节点
    ├── type=1（菜单）：页面路由节点
    └── type=2（按钮）：接口权限标识，如 "asset:info:add"
```

**权限标识规范**：`{模块}:{资源}:{操作}`

| 权限标识 | 说明 |
|----------|------|
| `asset:info:list` | 查看资产列表 |
| `asset:info:add` | 新增资产 |
| `asset:info:edit` | 编辑资产 |
| `asset:info:delete` | 删除资产 |
| `system:user:list` | 查看用户列表 |
| `system:role:add` | 新增角色 |

### 8.4 接口权限校验

```java
@RestController
@RequestMapping("/api/asset/info")
public class AssetInfoController {

    @PreAuthorize("hasAuthority('asset:info:list')")
    @GetMapping
    public Result<PageResult<AssetInfoVO>> page(AssetQueryDTO queryDTO) { ... }

    @PreAuthorize("hasAuthority('asset:info:add')")
    @PostMapping
    public Result<Map<String, Object>> save(@Valid @RequestBody AssetInfoDTO dto) { ... }

    @PreAuthorize("hasAuthority('asset:info:delete')")
    @DeleteMapping("/{id}")
    public Result<Void> remove(@PathVariable Long id) { ... }
}
```

### 8.5 密码安全

- 密码存储：使用 Spring Security 的 `BCryptPasswordEncoder`，自适应哈希（cost factor=10）；
- 密码传输：前端对密码进行 HTTPS 传输，禁止明文；
- 密码策略：最少8位，包含大小写字母和数字；
- 初始密码：管理员创建用户时生成随机初始密码，首次登录强制修改。

### 8.6 数据安全

- **SQL 注入防护**：MyBatis Plus `QueryWrapper` 使用预编译语句，杜绝 SQL 注入；
- **XSS 防护**：前端使用 Element Plus 内置转义，后端入参通过全局过滤器进行 HTML 转义；
- **CORS 配置**：仅允许配置白名单中的域名跨域访问；
- **敏感字段脱敏**：手机号、身份证等敏感字段在响应 VO 中进行掩码处理；
- **操作审计**：通过 AOP 操作日志记录所有写操作，保留操作人、操作时间、操作内容。

---

## 9. 性能设计

### 9.1 缓存策略

#### 9.1.1 Redis 缓存使用场景

| 缓存 Key | 缓存内容 | TTL | 失效策略 |
|----------|----------|-----|----------|
| `user:permissions:{userId}` | 用户权限列表 | 30分钟 | 权限变更时主动删除 |
| `menu:tree` | 全量菜单树 | 1小时 | 菜单变更时主动删除 |
| `dept:list` | 部门列表 | 1小时 | 部门变更时主动删除 |
| `category:tree` | 资产分类树 | 2小时 | 分类变更时主动删除 |
| `dashboard:overview` | 统计概览数据 | 5分钟 | 定时过期 |

#### 9.1.2 缓存更新模式

采用 **Cache-Aside（旁路缓存）** 模式：

```
读取流程：
  1. 先查 Redis → 命中：返回缓存数据
  2. 未命中 → 查 MySQL → 写入 Redis → 返回数据

写入流程：
  1. 更新 MySQL
  2. 删除对应 Redis 缓存（而非更新，避免并发写问题）
  3. 下次读取时重建缓存
```

#### 9.1.3 缓存序列化配置

```java
@Configuration
public class RedisConfig {
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        // Key 使用 String 序列化
        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        // Value 使用 Jackson 序列化（而非 JDK 默认序列化，节省空间且可读）
        Jackson2JsonRedisSerializer<Object> jsonSerializer =
            new Jackson2JsonRedisSerializer<>(Object.class);
        template.setValueSerializer(jsonSerializer);
        template.setHashValueSerializer(jsonSerializer);
        return template;
    }
}
```

### 9.2 数据库优化

#### 9.2.1 HikariCP 连接池配置

```yaml
spring:
  datasource:
    hikari:
      minimum-idle: 5               # 最小空闲连接数
      maximum-pool-size: 20         # 最大连接数（根据服务器配置调整）
      idle-timeout: 600000          # 空闲连接超时：10分钟
      connection-timeout: 30000     # 连接获取超时：30秒
      max-lifetime: 1800000         # 连接最大存活时间：30分钟（小于 MySQL wait_timeout）
      connection-test-query: SELECT 1
```

#### 9.2.2 分页查询优化

- 使用 MyBatis Plus 分页插件，自动注入 `LIMIT` 语句；
- 深分页（`OFFSET` 很大）场景，采用游标分页（`WHERE id > lastId LIMIT size`）优化；
- 大数据量列表查询使用覆盖索引，避免回表；
- 禁止 `SELECT *`，仅查询需要的字段，通过 `@TableField` 或 QueryWrapper 指定字段。

#### 9.2.3 慢查询监控

```yaml
# application.yml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl  # 开发环境开启SQL日志

# 生产环境通过 MySQL 慢查询日志监控
# slow_query_log = ON
# long_query_time = 2
```

### 9.3 前端性能优化

#### 9.3.1 构建优化（Vite）

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor-vue': ['vue', 'vue-router', 'pinia'],
          'vendor-element': ['element-plus'],
          'vendor-echarts': ['echarts']
        }
      }
    },
    chunkSizeWarningLimit: 1000
  }
})
```

#### 9.3.2 请求优化

- **接口防抖**：搜索输入框使用 300ms 防抖，减少无效请求；
- **请求取消**：页面切换时取消未完成的 Axios 请求（`AbortController`）；
- **虚拟列表**：大数据量表格使用 Element Plus 虚拟化表格（`el-table-v2`）；
- **图片懒加载**：资产图片附件使用 `IntersectionObserver` 懒加载。

#### 9.3.3 路由懒加载

```typescript
// router/index.ts - 所有页面组件使用动态 import 实现懒加载
const routes = [
  {
    path: '/asset/info',
    component: () => import('@/views/asset/info/index.vue')  // 懒加载
  }
]
```

---

## 10. 部署设计

### 10.1 环境要求

| 组件 | 最低要求 | 推荐配置 |
|------|----------|----------|
| 操作系统 | CentOS 7 / Ubuntu 20.04 | CentOS 8 / Ubuntu 22.04 |
| JDK | Java 17 | Java 17 LTS（OpenJDK / OracleJDK） |
| Node.js | 18.x | 20.x LTS |
| MySQL | 8.0.20 | 8.0.35+ |
| Redis | 6.0 | 7.x |
| Nginx | 1.18 | 1.24 |
| 服务器内存 | 4GB | 8GB+ |
| 服务器CPU | 2核 | 4核+ |
| 磁盘空间 | 50GB | 200GB+ |

### 10.2 后端部署步骤

**步骤一：构建 JAR 包**

```bash
# 在项目根目录执行
mvn clean package -DskipTests

# 构建产物位于
ls target/eams-*.jar
```

**步骤二：准备 MySQL 数据库**

```sql
-- 创建数据库
CREATE DATABASE eams CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建应用账号（生产环境不使用 root）
CREATE USER 'eams_user'@'localhost' IDENTIFIED BY 'StrongPassword@2025';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, INDEX
    ON eams.* TO 'eams_user'@'localhost';
FLUSH PRIVILEGES;

-- 执行初始化 SQL
mysql -u eams_user -p eams < sql/schema.sql
mysql -u eams_user -p eams < sql/data-init.sql
```

**步骤三：配置生产环境参数**

```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/eams?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: eams_user
    password: ${DB_PASSWORD}          # 通过环境变量注入，禁止硬编码
  data:
    redis:
      host: 127.0.0.1
      port: 6379
      password: ${REDIS_PASSWORD}     # 通过环境变量注入

jwt:
  secret: ${JWT_SECRET}               # 通过环境变量注入，生产环境必须替换

server:
  port: 9998
```

**步骤四：启动后端服务**

```bash
# 使用 systemd 管理（推荐）
cat > /etc/systemd/system/eams.service << EOF
[Unit]
Description=EAMS Backend Service
After=network.target mysql.service redis.service

[Service]
Type=simple
User=eams
WorkingDirectory=/opt/eams
ExecStart=/usr/bin/java \
    -Xms512m -Xmx1024m \
    -XX:+UseG1GC \
    -Dspring.profiles.active=prod \
    -DDJWT_SECRET=your-jwt-secret \
    -DDB_PASSWORD=your-db-password \
    -DREDIS_PASSWORD=your-redis-password \
    -jar /opt/eams/eams.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl enable eams
systemctl start eams
systemctl status eams
```

### 10.3 前端部署步骤

**步骤一：构建前端**

```bash
cd frontend

# 安装依赖
npm install

# 生产构建（配置 API 地址）
VITE_API_BASE_URL=https://your-domain.com npm run build

# 构建产物位于 frontend/dist/
ls dist/
```

**步骤二：配置 Nginx**

```nginx
# /etc/nginx/conf.d/eams.conf
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate     /etc/ssl/certs/eams.crt;
    ssl_certificate_key /etc/ssl/private/eams.key;
    ssl_protocols       TLSv1.2 TLSv1.3;

    # 前端静态资源
    root /opt/eams/frontend/dist;
    index index.html;

    # 前端路由（History 模式）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:9998;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_read_timeout 60s;
    }

    # WebSocket 代理
    location /ws/ {
        proxy_pass http://127.0.0.1:9998;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|gif|ico|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 安全响应头
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
}
```

### 10.4 Redis 安全配置

```conf
# /etc/redis/redis.conf（生产环境关键配置）
bind 127.0.0.1           # 仅监听本地，禁止外网访问
requirepass StrongRedisPassword@2025
maxmemory 512mb
maxmemory-policy allkeys-lru
appendonly yes           # 开启 AOF 持久化
```

### 10.5 健康检查

后端通过 Spring Boot Actuator 暴露健康检查端点：

```
GET http://127.0.0.1:9998/actuator/health

响应：
{
  "status": "UP",
  "components": {
    "db": { "status": "UP" },
    "redis": { "status": "UP" },
    "diskSpace": { "status": "UP" }
  }
}
```

---

## 11. 开发规范

### 11.1 命名规范

#### 11.1.1 Java 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类名 | UpperCamelCase | `AssetInfoService`，`GlobalExceptionHandler` |
| 方法名 | lowerCamelCase | `getAssetById`，`batchImportAssets` |
| 变量名 | lowerCamelCase | `assetNumber`，`purchaseAmount` |
| 常量名 | UPPER_SNAKE_CASE | `MAX_IMPORT_ROWS`，`TOKEN_PREFIX` |
| 包名 | 全小写 | `com.eams.asset.controller` |
| 数据库字段 | snake_case | `asset_number`，`create_time` |
| 接口路径 | 小写 kebab-case | `/api/asset-category/tree` |

#### 11.1.2 前端命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 组件文件 | PascalCase.vue | `AssetInfoList.vue`，`UserAvatar.vue` |
| TypeScript 文件 | camelCase.ts | `assetApi.ts`，`usePermission.ts` |
| Pinia Store | camelCase.ts + defineStore | `useAuthStore`，`useMenuStore` |
| CSS 类名 | kebab-case | `.asset-card`，`.search-form` |
| 常量 | UPPER_SNAKE_CASE | `TOKEN_KEY`，`DEFAULT_PAGE_SIZE` |

### 11.2 代码规范

#### 11.2.1 后端代码规范

**Controller 层规范**：

```java
@Tag(name = "资产信息管理")                         // Swagger 标签
@RestController
@RequestMapping("/api/asset/info")
@RequiredArgsConstructor                            // Lombok 构造器注入
public class AssetInfoController {

    private final AssetInfoService assetInfoService; // 接口注入，不用 @Autowired 字段注入

    @Operation(summary = "分页查询资产列表")
    @PreAuthorize("hasAuthority('asset:info:list')")
    @GetMapping
    public Result<PageResult<AssetInfoVO>> page(AssetQueryDTO queryDTO) {
        return Result.success(assetInfoService.page(queryDTO));
    }
}
```

**Service 层规范**：

```java
// 接口与实现分离，接口定义方法契约
public interface AssetInfoService extends IService<AssetInfo> {
    PageResult<AssetInfoVO> page(AssetQueryDTO queryDTO);
    void save(AssetInfoDTO dto);
    // ...
}

@Service
@Transactional(readOnly = true)              // 类级别只读事务（查询居多）
public class AssetInfoServiceImpl extends ServiceImpl<AssetInfoMapper, AssetInfo>
        implements AssetInfoService {

    @Override
    @Transactional                           // 写操作方法显式声明可写事务
    public void save(AssetInfoDTO dto) {
        // 1. 校验业务规则
        // 2. DTO → Entity（MapStruct）
        // 3. 持久化
        // 4. 写流转记录
    }
}
```

**Entity 层规范**：

```java
@Data
@TableName("asset_info")
public class AssetInfo {

    @TableId(type = IdType.AUTO)
    private Long id;

    private String assetNumber;

    @TableField(fill = FieldFill.INSERT)     // 自动填充创建时间
    private LocalDateTime createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;

    @TableLogic                              // 逻辑删除字段
    private Integer deleted;
}
```

#### 11.2.2 前端代码规范

**Vue 组件规范（`<script setup>` + TypeScript）**：

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { getAssetPage } from '@/api/asset'
import type { AssetInfo, AssetQueryParams } from '@/types/asset'

// Props 定义（使用 defineProps + TypeScript 类型）
const props = defineProps<{
  deptId?: number
}>()

// 组合式函数提取复用逻辑
const queryParams = reactive<AssetQueryParams>({
  current: 1,
  size: 10,
  deptId: props.deptId
})

const { data: pageData, loading, refresh } = useAssetPage(queryParams)

// 事件定义
const emit = defineEmits<{
  select: [asset: AssetInfo]
}>()
</script>
```

### 11.3 注释规范

- **类注释**：每个类必须包含 `@author`、功能描述；
- **方法注释**：公开方法必须编写 JavaDoc，说明参数含义和返回值；
- **业务逻辑注释**：复杂业务逻辑必须逐步注释，注释用中文；
- **TODO 注释**：临时未完成逻辑用 `// TODO: 说明` 标记，不允许遗留 `// FIXME`；
- **禁止废代码**：禁止提交注释掉的废弃代码，应通过 Git 历史找回。

### 11.4 Git 规范

#### 11.4.1 分支策略

```
main（主分支，只接受 PR 合并，受保护）
  ├── develop（开发集成分支）
  │     ├── feature/eams-101-asset-import（功能分支）
  │     ├── feature/eams-102-inventory-module（功能分支）
  │     └── bugfix/eams-201-asset-number-duplicate（缺陷修复）
  └── hotfix/eams-301-login-token-expire（紧急修复，从 main 拉取）
```

#### 11.4.2 Commit 消息规范

遵循 **Angular Commit Message Convention**：

```
<type>(<scope>): <subject>

<body>（可选，说明详细改动原因）

<footer>（可选，关联 Issue）
```

**type 类型**：

| type | 说明 |
|------|------|
| `feat` | 新功能 |
| `fix` | Bug 修复 |
| `docs` | 文档更新 |
| `style` | 代码格式调整（不影响逻辑） |
| `refactor` | 重构（不含新功能和 Bug 修复） |
| `perf` | 性能优化 |
| `test` | 测试相关 |
| `chore` | 构建工具、依赖更新等 |

**示例**：

```
feat(asset): 新增资产批量导入Excel功能

- 支持 .xlsx 格式，最大10MB
- 增加行级错误提示，返回失败行详情
- 使用 SXSSF 流式读取，避免 OOM

Closes #101
```

#### 11.4.3 代码审查要求

- 所有功能分支通过 Pull Request 合并，至少需要 1 人审查通过；
- PR 合并前必须通过所有自动化检查（单元测试、代码检查）；
- PR 描述必须说明改动目的、影响范围和测试方案。

### 11.5 接口开发流程

```
1. 后端定义接口（路径、参数、响应格式）
    │
    ▼
2. 在 Swagger（SpringDoc）中验证接口文档自动生成
    │
    ▼
3. 前端根据接口文档在 api/ 目录下封装请求方法
    │
    ▼
4. 联调测试（可使用 Mock 数据先行开发）
    │
    ▼
5. 代码审查 → 合并
```

---

## 附录

### A. 环境变量清单

| 变量名 | 说明 | 是否必须 |
|--------|------|----------|
| `JWT_SECRET` | JWT 签名密钥（至少32字符） | 是 |
| `DB_PASSWORD` | MySQL 数据库密码 | 是 |
| `REDIS_PASSWORD` | Redis 认证密码 | 是（生产环境） |
| `SPRING_PROFILES_ACTIVE` | Spring 激活 Profile（prod） | 是 |

### B. 常见问题排查

| 问题现象 | 排查方向 |
|----------|----------|
| 登录返回 401 | 检查密码是否正确，检查 `sys_user.status` 是否为1 |
| 接口返回 403 | 检查用户角色，检查角色是否已分配对应菜单权限 |
| 资产编号重复 | 检查 `asset_number_sequence` 表是否有并发问题，考虑加 Redis 分布式锁 |
| Excel 导出超时 | 检查导出数据量，建议单次导出不超过 5万条，超大量使用异步导出 |
| Redis 连接失败 | 检查 Redis 服务状态，检查 `requirepass` 配置是否与应用配置一致 |

### C. 版本更新记录

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v1.0.0 | 2025-01 | 初始版本，包含核心资产管理、系统管理、生命周期管理、采购管理模块 |

---

*本文档由 EAMS 项目组维护，如有疑问请联系技术负责人。*
