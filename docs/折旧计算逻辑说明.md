# 账单与资金管理模块 - 折旧计算逻辑说明

## 一、折旧计算方法

### 采用方法：直线法（Straight-Line Depreciation）

直线法是最常用的折旧方法，将资产的成本在其使用寿命期间平均分摊。

### 计算公式

```
月折旧额 = (采购金额 - 残值) / 使用年限（月）
累计折旧 = 月折旧额 × 已使用月数
净值 = 采购金额 - 累计折旧
```

## 二、关键参数

| 参数名称 | 说明 | 默认值 | 可配置 |
|---------|------|--------|--------|
| 采购金额 | 资产原始购入价格 | 必填 | 否 |
| 残值率 | 资产报废时的残值占原值比例 | 5% | 是 |
| 使用年限 | 资产预计可使用年限 | 60个月（5年） | 是 |
| 折旧精度 | 金额计算小数位数 | 2位 | 是 |

## 三、计算示例

### 示例1：笔记本电脑折旧计算

**资产信息：**
- 采购金额：¥8,000.00
- 残值率：5%
- 使用年限：36个月（3年）
- 已使用：12个月

**计算过程：**

```
1. 残值 = 8000 × 5% = 400.00元
2. 月折旧额 = (8000 - 400) / 36 = 211.11元
3. 累计折旧（12个月） = 211.11 × 12 = 2,533.32元
4. 净值 = 8000 - 2533.32 = 5,466.68元
```

### 示例2：服务器折旧计算

**资产信息：**
- 采购金额：¥50,000.00
- 残值率：5%
- 使用年限：60个月（5年）
- 已使用：24个月

**计算过程：**

```
1. 残值 = 50000 × 5% = 2,500.00元
2. 月折旧额 = (50000 - 2500) / 60 = 791.67元
3. 累计折旧（24个月） = 791.67 × 24 = 19,000.08元
4. 净值 = 50000 - 19000.08 = 31,000.08元
```

## 四、特殊情况处理

### 1. 资产报废
- **规则**：资产状态为"已报废"时停止计提折旧
- **处理**：保持报废时的累计折旧金额不变

### 2. 资产闲置
- **规则**：闲置状态继续计提折旧
- **原因**：资产仍在企业所有，时间损耗继续

### 3. 超期使用
- **规则**：累计折旧不超过"采购金额 - 残值"
- **处理**：达到使用年限后，净值保持为残值

### 4. 提前报废
- **规则**：可提前结束折旧
- **处理**：记录实际使用月数和累计折旧

## 五、配置参数

在 `application.yml` 中可配置折旧参数：

```yaml
asset:
  depreciation:
    # 残值率（百分比）
    residual-rate: 5
    # 默认使用年限（月）
    default-useful-life: 60
    # 计算精度（小数位）
    scale: 2
    # 舍入模式：HALF_UP（四舍五入）
    rounding-mode: HALF_UP
```

## 六、折旧计算时机

### 自动计算时机：
1. **月度账单生成时**：计算所有资产的当月折旧
2. **年度账单生成时**：汇总全年折旧情况
3. **资产详情查询时**：实时计算最新净值

### 手动触发：
- 管理员可手动触发账单生成

## 七、数据精度保证

### BigDecimal 使用规范：
```java
// 正确示例
BigDecimal amount = new BigDecimal("8000.00");
BigDecimal rate = new BigDecimal("0.05");
BigDecimal result = amount.multiply(rate)
    .setScale(2, RoundingMode.HALF_UP);

// 错误示例（避免）
BigDecimal amount = new BigDecimal(8000.00); // 可能丢失精度
```

### 计算要点：
- 所有金额计算使用 `BigDecimal`
- 统一使用 `setScale()` 设置精度
- 统一使用 `RoundingMode.HALF_UP`（四舍五入）

## 八、折旧报表

### 月度折旧报表包含：
- 本月新增资产数量和金额
- 本月折旧总额
- 累计折旧总额
- 资产净值总额

### 年度折旧报表包含：
- 年初资产总值
- 本年新增资产
- 本年折旧总额
- 年末资产净值
- 各部门资产分布

## 九、接口设计

### 折旧计算接口：

```java
/**
 * 计算单个资产的折旧信息
 * 
 * @param assetId 资产ID
 * @param targetDate 计算截止日期
 * @return 折旧信息（月折旧额、累计折旧、净值等）
 */
DepreciationInfo calculateDepreciation(Long assetId, LocalDate targetDate);

/**
 * 批量计算多个资产的折旧
 * 
 * @param assetIds 资产ID列表
 * @param targetDate 计算截止日期
 * @return 折旧信息列表
 */
List<DepreciationInfo> batchCalculateDepreciation(List<Long> assetIds, LocalDate targetDate);
```

## 十、注意事项

1. **金额精度**：所有金额字段必须使用 `DECIMAL(15,2)`
2. **时间计算**：月数计算精确到天，不足一月按整月计算
3. **并发控制**：账单生成时加锁，避免重复生成
4. **历史保留**：已生成的账单不可修改，只能作废重新生成
5. **审计追踪**：所有折旧计算记录操作日志

---

**文档版本**: V1.0  
**最后更新**: 2026-01-03  
**维护者**: EAMS开发团队
